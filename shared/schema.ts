import { sql, relations } from "drizzle-orm";
import { pgTable, text, serial, integer, boolean, timestamp, numeric, varchar, foreignKey } from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// --- Export models from integrations ---
export * from "./models/auth";
export * from "./models/chat";

// We need to import users to use them in relations
import { users } from "./models/auth";

// --- Application Tables ---

export const clients = pgTable("clients", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  company: text("company"),
  email: text("email"),
  phone: text("phone"),
  score: integer("score").default(100),
  isBlacklisted: boolean("is_blacklisted").default(false),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const companies = pgTable("companies", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  responsibleTelegram: text("responsible_telegram"),
  additionalInfo: text("additional_info"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const projects = pgTable("projects", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  description: text("description"), // ish nimalar qilish kerakligi
  clientId: integer("client_id").references(() => clients.id),
  companyId: integer("company_id").references(() => companies.id),
  type: text("type").notNull(), // web, bot, dizayn, server, marketing
  budget: numeric("budget").notNull(),
  currency: text("currency").notNull().default("UZS"), // UZS, USD
  startDate: timestamp("start_date").notNull(),
  deadlineDate: timestamp("deadline_date").notNull(),
  status: text("status").notNull().default("active"), // active, completed, delayed
  progress: integer("progress").default(0).notNull(), // 0-100%
  paymentProgress: integer("payment_progress").default(0).notNull(), // 0-100%
  riskLevel: text("risk_level").default("LOW"), // LOW, MEDIUM, HIGH
  priority: text("priority").default("medium").notNull(), // high, medium, low — ustunlik
  additionalRequirements: text("additional_requirements"), // qo'shimcha nimalar kerakligi
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const tasks = pgTable(
  "tasks",
  {
    id: serial("id").primaryKey(),
    projectId: integer("project_id").notNull().references(() => projects.id, { onDelete: "cascade" }),
    parentTaskId: integer("parent_task_id"),
    title: text("title").notNull(),
    description: text("description"),
    priority: text("priority").default("medium").notNull(), // low, medium, high
    status: text("status").default("todo").notNull(), // todo, in progress, done
    loggedMinutes: integer("logged_minutes").default(0).notNull(),
    createdAt: timestamp("created_at").defaultNow().notNull(),
    inProgressStartedAt: timestamp("in_progress_started_at"),
    completedAt: timestamp("completed_at"),
    dueDate: timestamp("due_date"),
    reopenComment: text("reopen_comment"),
  },
  (table) => ({
    parentTaskFk: foreignKey({
      columns: [table.parentTaskId],
      foreignColumns: [table.id],
      name: "tasks_parent_task_id_fkey",
    }).onDelete("cascade"),
  })
);

export const timeEntries = pgTable("time_entries", {
  id: serial("id").primaryKey(),
  taskId: integer("task_id").notNull().references(() => tasks.id, { onDelete: "cascade" }),
  userId: varchar("user_id").notNull().references(() => users.id),
  durationMinutes: integer("duration_minutes").notNull(),
  date: timestamp("date").defaultNow().notNull(),
  description: text("description"),
});

export const transactions = pgTable("transactions", {
  id: serial("id").primaryKey(),
  projectId: integer("project_id").references(() => projects.id, { onDelete: "set null" }),
  type: text("type").notNull(), // income, expense
  amount: numeric("amount").notNull(),
  currency: text("currency").default("UZS").notNull(),
  category: text("category").notNull(),
  description: text("description"),
  date: timestamp("date").defaultNow().notNull(),
});

export const invoices = pgTable("invoices", {
  id: serial("id").primaryKey(),
  projectId: integer("project_id").notNull().references(() => projects.id),
  invoiceNumber: text("invoice_number").notNull(),
  amount: numeric("amount").notNull(),
  currency: text("currency").default("UZS").notNull(), // USD | UZS — aniq
  status: text("status").default("pending").notNull(), // paid | pending | unpaid — To'langan | Kutilmoqda | To'lanmadi
  dueDate: timestamp("due_date").notNull(),
  pdfUrl: text("pdf_url"),
  paymentTerms: text("payment_terms"),
  clientName: text("client_name"),
  company: text("company"),
  billToContact: text("bill_to_contact"),
  /** Shartnoma: kim bn (qaysi mijoz/kompaniya) */
  contractPartner: text("contract_partner"),
  /** Shartnoma: boshlanish sanasi (qachon) */
  contractStartDate: timestamp("contract_start_date"),
  /** Shartnoma: tugash sanasi (qanchaga) */
  contractEndDate: timestamp("contract_end_date"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const invoiceItems = pgTable("invoice_items", {
  id: serial("id").primaryKey(),
  invoiceId: integer("invoice_id").notNull().references(() => invoices.id, { onDelete: "cascade" }),
  title: text("title").notNull(),
  quantity: integer("quantity").default(1).notNull(),
  unitPrice: numeric("unit_price").notNull(),
  /** row | server | api — 3 xil xizmat, PDFda 3 xil jadval */
  serviceType: text("service_type").default("row"),
  /** Server/API: boshlanish sanasi, quantity = necha oy, qolgan oy hisoblanadi */
  startDate: timestamp("start_date"),
  /** Server/API: qaysi loyiha uchun (projectId) */
  projectId: integer("project_id").references(() => projects.id),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

/** PDF faktura uchun sozlamalar (FROM, to'lov, imzo) — bitta qator. */
export const invoiceSettings = pgTable("invoice_settings", {
  id: serial("id").primaryKey(),
  companyName: text("company_name").default("SAYD.X LLC"),
  address: text("address").default("Toshkent, O'zbekiston"),
  phone: text("phone").default("+998 90 000 00 00"),
  email: text("email").default("info@saydx.uz"),
  website: text("website").default("saydx.uz"),
  bankName: text("bank_name").default("Your Bank Name"),
  accountNumber: text("account_number").default("1234 5678 9012 3456"),
  /** To'lov bo'yicha qo'shimcha qatorlar: sarlavha + qiymat (masalan Karta egasi, Karta raqami). JSON: [{title, value}, ...] */
  paymentDetailLines: text("payment_detail_lines"),
  paymentNote: text("payment_note").default("To'lov shartnoma asosida amalga oshiriladi."),
  authorizedName: text("authorized_name").default("Authorized Name"),
  authorizedPosition: text("authorized_position").default("Position"),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});

/** Moliya: qo'lda USD→UZS kursi (API ishlamasa ishlatiladi). Bitta qator. */
export const financeSettings = pgTable("finance_settings", {
  id: serial("id").primaryKey(),
  manualUsdToUzs: numeric("manual_usd_to_uzs").default("12500"), // 1 USD = ? UZS
});

// --- Relations ---

export const projectsRelations = relations(projects, ({ one, many }) => ({
  client: one(clients, {
    fields: [projects.clientId],
    references: [clients.id],
  }),
  tasks: many(tasks),
  transactions: many(transactions),
  invoices: many(invoices),
}));

export const invoicesRelations = relations(invoices, ({ one, many }) => ({
  project: one(projects, { fields: [invoices.projectId], references: [projects.id] }),
  items: many(invoiceItems),
}));

export const tasksRelations = relations(tasks, ({ one, many }) => ({
  project: one(projects, {
    fields: [tasks.projectId],
    references: [projects.id],
  }),
  parentTask: one(tasks, { fields: [tasks.parentTaskId], references: [tasks.id], relationName: "subtasks" }),
  subtasks: many(tasks, { relationName: "subtasks" }),
  timeEntries: many(timeEntries),
}));

export const clientsRelations = relations(clients, ({ many }) => ({
  projects: many(projects),
}));

export const invoiceItemsRelations = relations(invoiceItems, ({ one }) => ({
  invoice: one(invoices, { fields: [invoiceItems.invoiceId], references: [invoices.id] }),
}));

// --- Zod Schemas ---

export const insertClientSchema = createInsertSchema(clients).omit({ id: true, createdAt: true });
export const insertCompanySchema = createInsertSchema(companies).omit({ id: true, createdAt: true });
export const insertProjectSchema = createInsertSchema(projects).omit({ id: true, createdAt: true, riskLevel: true });
export const insertTaskSchema = createInsertSchema(tasks).omit({ id: true, createdAt: true, loggedMinutes: true });
export const insertTimeEntrySchema = createInsertSchema(timeEntries).omit({ id: true, date: true });
export const insertTransactionSchema = createInsertSchema(transactions).omit({ id: true, date: true });
export const insertInvoiceSchema = createInsertSchema(invoices).omit({ id: true, createdAt: true });
export const insertInvoiceItemSchema = createInsertSchema(invoiceItems).omit({ id: true, createdAt: true });

export const paymentDetailLineSchema = z.object({ title: z.string(), value: z.string() });
export const updateInvoiceSettingsSchema = z.object({
  companyName: z.string().optional(),
  address: z.string().optional(),
  phone: z.string().optional(),
  email: z.string().optional(),
  website: z.string().optional(),
  bankName: z.string().optional(),
  accountNumber: z.string().optional(),
  paymentDetailLines: z.array(paymentDetailLineSchema).optional(),
  paymentNote: z.string().optional(),
  authorizedName: z.string().optional(),
  authorizedPosition: z.string().optional(),
});

// --- Types ---

export type User = typeof users.$inferSelect;
export type Client = typeof clients.$inferSelect;
export type InsertClient = z.infer<typeof insertClientSchema>;
export type Company = typeof companies.$inferSelect;
export type InsertCompany = z.infer<typeof insertCompanySchema>;

export type Project = typeof projects.$inferSelect;
export type InsertProject = z.infer<typeof insertProjectSchema>;
export type UpdateProjectRequest = Partial<InsertProject>;

export type Task = typeof tasks.$inferSelect;
export type InsertTask = z.infer<typeof insertTaskSchema>;
export type UpdateTaskRequest = Partial<InsertTask>;

export type TimeEntry = typeof timeEntries.$inferSelect;
export type InsertTimeEntry = z.infer<typeof insertTimeEntrySchema>;

export type Transaction = typeof transactions.$inferSelect;
export type InsertTransaction = z.infer<typeof insertTransactionSchema>;

export type Invoice = typeof invoices.$inferSelect;
export type InsertInvoice = z.infer<typeof insertInvoiceSchema>;
export type InvoiceItem = typeof invoiceItems.$inferSelect;
export type InsertInvoiceItem = z.infer<typeof insertInvoiceItemSchema>;

export type InvoiceSettings = typeof invoiceSettings.$inferSelect;
export type UpdateInvoiceSettings = z.infer<typeof updateInvoiceSettingsSchema>;
